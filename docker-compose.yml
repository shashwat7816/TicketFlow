version: '3.8'
services:
  mongo:
    image: mongo:6.0
    command: ["--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - ./backend/docker/init-rs.js:/docker-entrypoint-initdb.d/init-rs.js:ro
    # Do not publish Mongo's port by default to avoid conflicts with local Mongo instances.
    # Backend connects to the service via Docker network at 'mongo:27017'.
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.adminCommand({ ping: 1 })' || exit 1"]
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - MONGO_URI=mongodb://mongo:27017/ticketflow?replicaSet=rs0
      - PORT=4000
    ports:
      - 4000:4000
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - ./backend:/app:delegated
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - 3000:80
    depends_on:
      - backend
    restart: unless-stopped
